üìÑ Prompt –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º pg-ha-patroni

–Ø —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL —Å Patroni –∏ Consul —Å –ø–æ–º–æ—â—å—é Ansible –∏ Vagrant.
–ù—É–∂–µ–Ω –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

üîπ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
1. –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è pg-ha-patroni.

–í –Ω—ë–º —Ö—Ä–∞–Ω–∏—Ç—Å—è:

Vagrant-—Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª–æ–∫ (—á–µ—Ä–µ–∑ libvirt/vagrant-libvirt).

Ansible-–ø–ª–µ–π–±—É–∫–∏ –∏ —Ä–æ–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Consul, Patroni –∏ PostgreSQL.

–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python (ansible-venv), –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞.

–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–µ–π (create_consul_server_role.sh, create_consul_client_role.sh –∏ —Ç.–¥.).

2. Vagrant

–ü–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã:

consul ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è VM –¥–ª—è Consul Server.

db1, db2 ‚Üí PostgreSQL –Ω–æ–¥—ã —Å Patroni –∏ Consul Agent.

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å libvirt –±—ã–ª–∏ –Ω—é–∞–Ω—Å—ã:

–Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –¥–∏—Å–∫–æ–≤ (/var/lib/libvirt/images/...).

–ª—É—á—à–µ —É–∫–∞–∑—ã–≤–∞—Ç—å storage pool –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å relative paths.

3. Ansible

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Ansible —Å–æ–±—Ä–∞–Ω—ã –≤ ansible.cfg –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

[defaults]
inventory = ansible/learn-inventory/inventory.ini
remote_user = vagrant
private_key_file = /home/dima/.ssh/id_ed25519
host_key_checking = False
roles_path = ansible/playbook-library/roles

[privilege_escalation]
become = True
become_method = sudo
become_user = root


–ò–Ω–≤–µ–Ω—Ç–æ—Ä–∏ (inventory.ini) —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä—É–ø–ø—ã:

[consul]
192.168.121.10

[db]
192.168.121.11
192.168.121.12

4. Ansible —Ä–æ–ª–∏

–°–¥–µ–ª–∞–Ω—ã —Ä–æ–ª–∏ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

consul_server ‚Üí –¥–ª—è Consul —Å–µ—Ä–≤–µ—Ä–∞.

consul_client ‚Üí –¥–ª—è Consul –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–æ–¥–∞—Ö Patroni.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–ª–µ–π:

roles/
  consul_server/
    tasks/
      main.yml
    templates/
    handlers/
    defaults/
    files/
    vars/
  consul_client/
    ...


–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–µ–π –µ—Å—Ç—å bash-—Å–∫—Ä–∏–ø—Ç—ã:

create_consul_server_role.sh

create_consul_client_role.sh
(–æ–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–æ–ª–∏).

5. Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥ ansible-venv/.

–û–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —á—Ç–æ–±—ã –Ω–∞ –ª—é–±–æ–º –ü–ö –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–¥—ë—Ç —á–µ—Ä–µ–∑ —Ñ–∞–π–ª requirements-ansible.txt.

6. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è PG_HA_PATRONI_HOME, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞.

–¢–∞–∫–∂–µ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è ANSIBLE_CONFIG=$PG_HA_PATRONI_HOME/ansible.cfg.

7. Direnv

–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è direnv.

–í –∫–æ—Ä–Ω–µ –µ—Å—Ç—å .envrc, –≤ –∫–æ—Ç–æ—Ä–æ–º:

–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –æ–∫—Ä—É–∂–µ–Ω–∏–µ ansible-venv,

—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

export PG_HA_PATRONI_HOME=/.../pg-ha-patroni
export ANSIBLE_CONFIG=$PG_HA_PATRONI_HOME/ansible.cfg


–ß—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç init/init.sh, –∫–æ—Ç–æ—Ä—ã–π:

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç/—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç direnv.

–ü–æ–¥–∫–ª—é—á–∞–µ—Ç direnv hook –≤ ~/.bashrc –∏–ª–∏ ~/.zshrc.

–°–æ–∑–¥–∞—ë—Ç ansible-venv, –µ—Å–ª–∏ –Ω–µ—Ç.

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements-ansible.txt.

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .envrc.

–ü—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –¥–ª—è direnv, –∏ –¥–ª—è —Ä—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (bin/activate).

üîπ –ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

–ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–∑–≤–∏–≤–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL Patroni + Consul.

–ü–æ–º–æ–≥–∞—Ç—å –ø–∏—Å–∞—Ç—å —Ä–æ–ª–∏ –∏ –ø–ª–µ–π–±—É–∫–∏ –¥–ª—è:

Consul —Å–µ—Ä–≤–µ—Ä–æ–≤,

Consul –∫–ª–∏–µ–Ω—Ç–æ–≤,

Patroni,

PostgreSQL.

–ü–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å best practices (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Ansible, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ group_vars, host_vars).

–î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ CI/CD (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏ Molecule-–æ–º).

–î–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –¥–µ–ø–ª–æ–π, –º–∏–≥—Ä–∞—Ü–∏—è).

–ë—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∫ —Ç–æ–º—É, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å—Å—è –Ω–∞ –ª—é–±–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏–∑ GitHub.

üëâ –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
–ö–æ–≥–¥–∞ —è –æ–±—Ä–∞—â–∞—é—Å—å –≤ –Ω–æ–≤–æ–º —á–∞—Ç–µ, —Å—á–∏—Ç–∞–π, —á—Ç–æ –≤—Å—ë –≤—ã—à–µ ‚Äî —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.