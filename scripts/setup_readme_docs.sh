#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
DOCS_DIR="$ROOT/docs"

mkdir -p "$DOCS_DIR"

# ÐœÐ¸Ð½Ð¸-README.md
cat > "$ROOT/README.md" <<'EOF'
# pg-ha-patroni

Ð˜Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð»Ñ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° **PostgreSQL** Ñ **Patroni** Ð¸ **Consul**, Ñ€Ð°Ð·Ð²Ñ‘Ñ€Ñ‚Ñ‹Ð²Ð°ÐµÐ¼Ð°Ñ Ñ‡ÐµÑ€ÐµÐ· **Ansible** Ð¸ **Vagrant/libvirt**.

---

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

git clone git@github.com:you/pg-ha-patroni.git
cd pg-ha-patroni
make setup                         # ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
make init                          # ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ venv, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ansible, Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ .envrc
direnv allow                       # Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ direnv Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒ .envrc
make up [node_inventory]           # Ð¿Ð¾Ð´Ð½ÑÑ‚ÑŒ ÐºÐ»Ð°ÑÑ‚ÐµÑ€
make ansible [node_inventory]      # Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð½Ð¾Ð´

---

## âš™ï¸ Makefile ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹

- make setup â†’ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
- make init â†’ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° venv, ansible Ð¸ .envrc
- make up [node_inventory] / halt [node_inventory] / destroy [node_inventory] â†’ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð¾Ð¼ Vagrant
- make ssh node_inventory â†’ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð¾Ð´Ð°Ð¼
- make ansible [node_inventory] â†’ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð²ÑÐµÑ… Ð½Ð¾Ð´

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð¸ workflow â€” docs/WORKFLOW.md

---

## ðŸ› ï¸ Direnv Ð¸ venv

Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð² ~/.bashrc Ð¸Ð»Ð¸ ~/.zshrc:

eval "$(direnv hook bash)"

ÐŸÐ¾ÑÐ»Ðµ make init Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .envrc:
direnv allow

Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸ÑŽ venv Ð¸ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ â€” docs/DIRENV.md

---

## ðŸŽ¨ ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ð°Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ° Ñ venv

Ð§Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ venv Ð² PS1:

- Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ scripts/examples/bash-prompt.sh Ð² ÐšÐžÐÐ•Ð¦~/.bashrc Ð¸Ð»Ð¸ ~/.zshrc
- ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» Ð¸Ð»Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ source ~/.bashrc

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ â€” scripts/examples/bash-prompt.sh

---

## ðŸ“Œ ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ

- Ð’ÑÐµ Ð¿ÑƒÑ‚Ð¸ Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð·Ð°Ð²Ð¸ÑÑÑ‚ Ð¾Ñ‚ $PG_HA_PATRONI_HOME
- ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ, Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ workflow Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð¾Ð»ÑÐ¼ Ansible Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² Ð¿Ð°Ð¿ÐºÐµ docs
EOF

# WORKFLOW.md
cat > "$DOCS_DIR/WORKFLOW.md" <<'EOF'
# Workflow Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° pg-ha-patroni

## ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ» Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Git clone    â”‚
â”‚ pg-ha-patroniâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ make setup   â”‚
â”‚ (ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ make init    â”‚
â”‚ (venv, ansible, .envrc) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ direnv allow â”‚
â”‚ (Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ venv Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ make up      â”‚
â”‚ (Ð¿Ð¾Ð´Ð½ÑÑ‚ÑŒ ÐºÐ»Ð°ÑÑ‚ÐµÑ€) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ make ansible â”‚
â”‚ (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ÐšÐ»Ð°ÑÑ‚ÐµÑ€       â”‚
â”‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
 â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚              â”‚
 â–¼              â–¼
make halt     make destroy
â”‚              â”‚
â”‚ ÐŸÐ¾ÑÐ»Ðµ halt Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€
â”‚ Ð¸ Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð¾Ð¼
â”‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ make up / vagrant up
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### ÐŸÐ¾ÑÑÐ½ÐµÐ½Ð¸Ñ

- make halt â€” Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° VM, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° Ð½Ð° Ð´Ð¸ÑÐºÐ¸
- make destroy â€” ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ³Ð¾ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð½ÐµÐ¼ Ñ Ð´Ð¸ÑÐºÐ¾Ð²
- Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ»: ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° â†’ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ â†’ Ð¿Ð¾Ð´Ð½ÑÑ‚Ð¸Ðµ â†’ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° â†’ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð¾Ð¼
EOF

# DIRENV.md
cat > "$DOCS_DIR/DIRENV.md" <<'EOF'
# Direnv Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ venv

ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ direnv Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ.

## ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ direnv Ðº Ð¾Ð±Ð¾Ð»Ð¾Ñ‡ÐºÐµ

Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð² ~/.bashrc Ð¸Ð»Ð¸ ~/.zshrc:

eval "$(direnv hook bash)"

## Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ

1. ÐŸÐ¾ÑÐ»Ðµ make init Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ñ„Ð°Ð¹Ð» .envrc:

export PG_HA_PATRONI_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export ANSIBLE_CONFIG=$PG_HA_PATRONI_HOME/ansible.cfg
source $PG_HA_PATRONI_HOME/ansible-venv/bin/activate

2. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ direnv Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÑ‚ÑŒ .envrc:

direnv allow

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸ Ð·Ð°Ñ…Ð¾Ð´Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:

- ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ansible-venv
- Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ $PG_HA_PATRONI_HOME Ð¸ $ANSIBLE_CONFIG
EOF


echo "âœ… ÐœÐ¸Ð½Ð¸-README Ð¸ docs/ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹!"
